#!/usr/bin/python
# -*-python-*-
#
# tritium.py -- a keyboard driven window manager
#
# Copyright 2007 Mike O'Connor <stew@vireo.org>
#
# Portions of code plagarized from plwm's panes.py which is
#    Copyright (C) 2001  Mike Meyer <mwm@mired.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

import sys

from plwm import wmanager, keys, inspect, \
     border, color, font, menu, cfilter,outline, focus
     
import logging
import tritium
import sys,os
from tritium import tab,workspace,frame,title
from tritium.query import *
from tritium.submap import SubMap
from Xlib import XK 

log = logging.getLogger()


class TritiumMenuHandler(menu.MenuCharHandler):
    Any_Escape = C_g = menu.MenuKeyHandler._abort
    Any_Return = menu.MenuKeyHandler._do
    Any_space = Any_Down = C_n = menu.MenuKeyHandler._down
    Any_BackSpace = Any_Up = C_p = menu.MenuKeyHandler._up

class TritiumClient( wmanager.Client,
		     border.BorderClient,
		     tritium.title.TitleClient,
		     tritium.tab.TabClient,
		     tritium.frame.FrameClient,
		     workspace.WorkspaceClient,
                     ):
    "Put the clients in a frame, with a border."

    border_default_width = 1
    border_color_name = 'White'
    border_focuscolor_name = 'White'

class LayoutScreen:
    def __screen_client_init__( self ):
        import layout

        method = "screen_%d" % self.number

        if layout.TritiumLayout.__dict__.has_key( method ):
            layout.TritiumLayout.__dict__[method]( self )

class TritiumScreen( wmanager.Screen,
		     color.Color,
                     LayoutScreen,
		     message.screenMessage,
		     tritium.tritiumScreen,
		     menu.screenMenu,
		     tritium.title.TitleScreen):
    "And panes on the screen, and I'm going to want some menus."

    menu_handler = TritiumMenuHandler
    menu_bordercolor = "Red"
    message_bordercolor = "Blue"


class TritiumConfig:
    def __wm_screen_init__( self ):
        log.debug( "TritiumConfig.__wm_screen_init__" )
        # the directories we searce for keys.py and layout.py in reverse order:
        sys.path.insert( 0, "/etc/X11/tritium/config" )
        sys.path.insert( 0, "/etc/tritium/config" )
        sys.path.insert( 0, "/usr/local/etc/X11/tritium/config" )
        sys.path.insert( 0, "/usr/local/etc/tritium/config" )
        sys.path.insert( 0, os.path.join( os.getenv('HOME'), ".tritium" ), )
        sys.path.insert( 0, os.path.join( os.getenv('HOME'), ".config/tritium/config" ) )

    def __wm_init__( self ):
        "install the tritium key map"

        import keys
        keys.TritiumKeys(self)


        # TODO: this should be moved into a patch in debian/patches
        menufile='/var/lib/tritium/debian-menu.py'
        if os.path.isfile( menufile ):
            try:
                log.info( "loading menus from %s" % menufile )
                menus = open( menufile )
                exec menus in {'wm': self}
            except:
                log.error( "error loading menu file: %s: %s, %s" % (menufile, sys.exc_info()[0],sys.exc_info()[1] ))



class Tritium( wmanager.WindowManager,
               focus.SloppyFocus,
               font.Font,
               workspace.WorkspaceWindowManager,
               TritiumConfig,
               tritium.tritiumWindowManager,
               inspect.InspectServer,
               ):
    client_class = TritiumClient
    screen_class = TritiumScreen

if __name__ == '__main__':
    os.environ[ "DISPLAY" ] = ":0"

    level=logging.INFO
    # right now all we understand is -d for debug
    if len( sys.argv ) > 1:
        if( len( sys.argv ) == 2 ):
            if sys.argv.pop() == '-d':
                level=logging.DEBUG
            else:
                usage()
        else:
            usage()

    logging.basicConfig( level=level,
                         format='%(asctime)s %(levelname)s %(message)s',
                         stream = sys.stderr )

    wmanager.main(Tritium)
